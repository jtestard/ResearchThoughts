rewriting if then else with left outer join and group by.